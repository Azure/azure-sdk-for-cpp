
steps:
  - pwsh: |
      $tempFile = New-TemporaryFile;
      systeminfo.exe /fo csv > $tempFile
      $osName = (Import-Csv $tempFile).'OS Name'

      Write-Host "OS Name: $osName"
      if (!($osName -like '*2022*')) {
        Write-Host "OS is not Windows Server 2022, skipping MSVC changes"
        exit 0
      }

      Remove-item 'C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\Microsoft.VCToolsVersion.v143.default.*' -Force
      Get-ChildItem ''C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\' -Name | Write-Host
      # Write-Host "Removing VC components..."

      # Set-Location "C:\Program Files (x86)\Microsoft Visual Studio\Installer\"
      # $InstallPath = "C:\Program Files\Microsoft Visual Studio\2022\Enterprise"
      # $componentsToRemove= @(
      #   "Microsoft.VisualStudio.Component.VC.Tools.ARM",
      #   "Microsoft.VisualStudio.Component.VC.MFC.ARM",
      #   "Microsoft.VisualStudio.Component.VC.MFC.ARM.Spectre",
      #   "Microsoft.VisualStudio.Component.VC.ATL.ARM64",
      #   "Microsoft.VisualStudio.Component.VC.ATL.ARM64.Spectre",
      #   "Microsoft.VisualStudio.Component.VC.MFC.ARM64",
      #   "Microsoft.VisualStudio.Component.VC.MFC.ARM64.Spectre",
      #   "Microsoft.VisualStudio.Component.VC.Modules.x86.x64",
      #   "Microsoft.VisualStudio.Component.VC.Tools.ARM64",
      #   "Microsoft.VisualStudio.Component.VC.Tools.ARM64EC",
      #   "Microsoft.VisualStudio.Component.VC.Redist.MSM",
      #   "Microsoft.VisualStudio.Component.VC.v141.x86.x64",
      #   "Microsoft.VisualStudio.Component.VC.v141.x86.x64.Spectre",
      #   "Microsoft.VisualStudio.Component.VC.v141.ARM.Spectre",
      #   "Microsoft.VisualStudio.Component.VC.v141.ARM64.Spectre",
      #   "Microsoft.VisualStudio.Component.VC.v141.MFC",
      #   "Microsoft.VisualStudio.Component.VC.v141.MFC.Spectre",
      #   "Microsoft.VisualStudio.Component.VC.14.29.16.11.ARM",
      #   "Microsoft.VisualStudio.Component.VC.14.29.16.11.ARM.Spectre",
      #   "Microsoft.VisualStudio.Component.VC.14.29.16.11.ARM64",
      #   "Microsoft.VisualStudio.Component.VC.14.29.16.11.ARM64.Spectre",
      #   "Microsoft.VisualStudio.Component.VC.14.29.16.11.x86.x64",
      #   "Microsoft.VisualStudio.Component.VC.14.29.16.11.x86.x64.Spectre",
      #   "Microsoft.VisualStudio.Component.VC.14.29.16.11.ATL",
      #   "Microsoft.VisualStudio.Component.VC.14.29.16.11.ATL.Spectre",
      #   "Microsoft.VisualStudio.Component.VC.14.29.16.11.ATL.ARM",
      #   "Microsoft.VisualStudio.Component.VC.14.29.16.11.ATL.ARM.Spectre",
      #   "Microsoft.VisualStudio.Component.VC.14.29.16.11.ATL.ARM64",
      #   "Microsoft.VisualStudio.Component.VC.14.29.16.11.ATL.ARM64.Spectre",
      #   "Microsoft.VisualStudio.Component.VC.14.29.16.11.MFC",
      #   "Microsoft.VisualStudio.Component.VC.14.29.16.11.MFC.Spectre",
      #   "Microsoft.VisualStudio.Component.VC.14.29.16.11.MFC.ARM",
      #   "Microsoft.VisualStudio.Component.VC.14.29.16.11.MFC.ARM.Spectre",
      #   "Microsoft.VisualStudio.Component.VC.14.29.16.11.MFC.ARM64",
      #   "Microsoft.VisualStudio.Component.VC.14.29.16.11.MFC.ARM64.Spectre",
      #   "Microsoft.VisualStudio.Component.VC.14.38.17.8.ARM",
      #   "Microsoft.VisualStudio.Component.VC.14.38.17.8.ARM.Spectre",
      #   "Microsoft.VisualStudio.Component.VC.14.38.17.8.ARM64",
      #   "Microsoft.VisualStudio.Component.VC.14.38.17.8.ARM64.Spectre",
      #   "Microsoft.VisualStudio.Component.VC.14.38.17.8.ATL",
      #   "Microsoft.VisualStudio.Component.VC.14.38.17.8.ATL.ARM",
      #   "Microsoft.VisualStudio.Component.VC.14.38.17.8.ATL.ARM.Spectre",
      #   "Microsoft.VisualStudio.Component.VC.14.38.17.8.ATL.ARM64",
      #   "Microsoft.VisualStudio.Component.VC.14.38.17.8.ATL.ARM64.Spectre",
      #   "Microsoft.VisualStudio.Component.VC.14.38.17.8.ATL.Spectre",
      #   "Microsoft.VisualStudio.Component.VC.14.38.17.8.MFC",
      #   "Microsoft.VisualStudio.Component.VC.14.38.17.8.MFC.ARM",
      #   "Microsoft.VisualStudio.Component.VC.14.38.17.8.MFC.ARM.Spectre",
      #   "Microsoft.VisualStudio.Component.VC.14.38.17.8.MFC.ARM64",
      #   "Microsoft.VisualStudio.Component.VC.14.38.17.8.MFC.ARM64.Spectre",
      #   "Microsoft.VisualStudio.Component.VC.14.38.17.8.MFC.Spectre",
      #   "Microsoft.VisualStudio.Component.VC.14.38.17.8.x86.x64",
      #   "Microsoft.VisualStudio.Component.VC.14.38.17.8.x86.x64.Spectre",
      #   "Microsoft.VisualStudio.Component.VC.14.39.17.9.ARM",
      #   "Microsoft.VisualStudio.Component.VC.14.39.17.9.ARM.Spectre",
      #   "Microsoft.VisualStudio.Component.VC.14.39.17.9.ARM64",
      #   "Microsoft.VisualStudio.Component.VC.14.39.17.9.ARM64.Spectre",
      #   "Microsoft.VisualStudio.Component.VC.14.39.17.9.ATL",
      #   "Microsoft.VisualStudio.Component.VC.14.39.17.9.ATL.ARM",
      #   "Microsoft.VisualStudio.Component.VC.14.39.17.9.ATL.ARM.Spectre",
      #   "Microsoft.VisualStudio.Component.VC.14.39.17.9.ATL.ARM64",
      #   "Microsoft.VisualStudio.Component.VC.14.39.17.9.ATL.ARM64.Spectre",
      #   "Microsoft.VisualStudio.Component.VC.14.39.17.9.ATL.Spectre",
      #   "Microsoft.VisualStudio.Component.VC.14.39.17.9.MFC",
      #   "Microsoft.VisualStudio.Component.VC.14.39.17.9.MFC.ARM",
      #   "Microsoft.VisualStudio.Component.VC.14.39.17.9.MFC.ARM.Spectre",
      #   "Microsoft.VisualStudio.Component.VC.14.39.17.9.MFC.ARM64",
      #   "Microsoft.VisualStudio.Component.VC.14.39.17.9.MFC.ARM64.Spectre",
      #   "Microsoft.VisualStudio.Component.VC.14.39.17.9.MFC.Spectre",
      #   "Microsoft.VisualStudio.Component.VC.14.39.17.9.x86.x64",
      #   "Microsoft.VisualStudio.Component.VC.14.39.17.9.x86.x64.Spectre",
      #   "Microsoft.VisualStudio.Component.VC.ATLMFC",
      #   "Microsoft.VisualStudio.Component.VC.ATLMFC.Spectre",
      #   "Microsoft.VisualStudio.ComponentGroup.UWP.VC.v142",
      #   "Microsoft.VisualStudio.Workload.NativeCrossPlat",
      #   "Microsoft.VisualStudio.Workload.NativeDesktop",
      #   "Microsoft.VisualStudio.Workload.NativeGame",
      #   "Microsoft.VisualStudio.Workload.NativeMobile"
      # )
      # [string]$workloadArgs = $componentsToRemove | ForEach-Object {" --remove " +  $_}
      # $Arguments = ('/c', "vs_installer.exe", 'modify', '--installPath', "`"$InstallPath`"",$workloadArgs, '--quiet', '--norestart', '--nocache')
      # # should be run twice
      # $process = Start-Process -FilePath cmd.exe -ArgumentList $Arguments -Wait -PassThru -WindowStyle Hidden
      # $process = Start-Process -FilePath cmd.exe -ArgumentList $Arguments -Wait -PassThru -WindowStyle Hidden

      # Write-Host "Installing VC components..."

      # $componentsToInstall= @(
      #   "Microsoft.VisualStudio.Component.VC.Tools.x86.x64",
      #   "Microsoft.VisualStudio.Component.VC.Runtimes.x86.x64.Spectre",
      #   "Microsoft.VisualStudio.Component.VC.Modules.x86.x64",
      #   "Microsoft.VisualStudio.Component.VC.14.38.17.8.x86.x64",
      #   "Microsoft.VisualStudio.Component.VC.14.38.17.8.x86.x64.Spectre"
      # )
      # [string]$workloadArgs = $componentsToInstall | ForEach-Object {" --add " +  $_}
      # $Arguments = ('/c', "vs_installer.exe", 'modify', '--installPath', "`"$InstallPath`"",$workloadArgs, '--quiet', '--norestart', '--nocache')
      # # should be run twice
      # $process = Start-Process -FilePath cmd.exe -ArgumentList $Arguments -Wait -PassThru -WindowStyle Hidden
      # $process = Start-Process -FilePath cmd.exe -ArgumentList $Arguments -Wait -PassThru -WindowStyle Hidden

      # Write-Host "Done"

      # Get-ChildItem -Path "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Tools\MSVC" -Name
    displayName: Setup MSVC
    condition: eq(variables['Agent.OS'], 'Windows_NT')
