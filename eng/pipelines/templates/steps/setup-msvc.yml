
steps:
  - pwsh: |
      $tempFile = New-TemporaryFile;
      systeminfo.exe /fo csv > $tempFile
      $osName = (Import-Csv $tempFile).'OS Name'

      Write-Host "OS Name: $osName"
      if (!($osName -like '*2022*')) {
        Write-Host "OS is not Windows Server 2022, skipping MSVC changes"
        exit 0
      }

      Write-Host "Removing VC components..."

      Set-Location "C:\Program Files (x86)\Microsoft Visual Studio\Installer\"
      $InstallPath = "C:\Program Files\Microsoft Visual Studio\2022\Enterprise"
      $componentsToRemove= @(
        "Microsoft.VisualStudio.Component.VC.Tools.x86.x64"
      )
      [string]$workloadArgs = $componentsToRemove | ForEach-Object {" --remove " +  $_}
      $Arguments = ('/c', "vs_installer.exe", 'modify', '--installPath', "`"$InstallPath`"",$workloadArgs, '--quiet', '--norestart', '--nocache')
      # should be run twice
      $process = Start-Process -FilePath cmd.exe -ArgumentList $Arguments -Wait -PassThru -WindowStyle Hidden
      $process = Start-Process -FilePath cmd.exe -ArgumentList $Arguments -Wait -PassThru -WindowStyle Hidden

      Write-Host "Installing VC components..."

      $componentsToInstall= @(
        "Microsoft.VisualStudio.Component.VC.Tools.x86.x64"
      )
      [string]$workloadArgs = $componentsToInstall | ForEach-Object {" --add " +  $_}
      $Arguments = ('/c', "vs_installer.exe", 'modify', '--installPath', "`"$InstallPath`"",$workloadArgs, '--quiet', '--norestart', '--nocache')
      # should be run twice
      $process = Start-Process -FilePath cmd.exe -ArgumentList $Arguments -Wait -PassThru -WindowStyle Hidden
      $process = Start-Process -FilePath cmd.exe -ArgumentList $Arguments -Wait -PassThru -WindowStyle Hidden

      Write-Host "Done"
    displayName: Setup MSVC
    condition: eq(variables['Agent.OS'], 'Windows_NT')
