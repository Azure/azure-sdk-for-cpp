parameters:
  Condition: failed()
  SourceFolder: $(Build.SourcesDirectory)
  ContentExpression: /**/build/**/*.log
  ArtifactName: BuildFailureLogs_$(Agent.JobName)_$(System.JobAttempt)

steps:
  - task: CopyFiles@2
    condition: ${{ parameters.Condition }}
    displayName: Stage failure logs for upload
    inputs:
      SourceFolder: $(Build.SourcesDirectory)
      Contents: '${{ parameters.ContentExpression }}'
      TargetFolder: $(Build.ArtifactStagingDirectory)/failurelogs

  - task: PublishPipelineArtifact@1
    condition: ${{ parameters.Condition }}
    displayName: Publish failure logs
    inputs:
      targetPath: $(Build.ArtifactStagingDirectory)/failurelogs
      artifactName: ${{ parameters.ArtifactName }}

  - task: DeleteFiles@1
    condition: ${{ parameters.Condition }}
    displayName: Delete failure logs staging folder
    inputs:
      SourceFolder: $(Build.ArtifactStagingDirectory)/failurelogs
      Contents: '*'
      RemoveSourceFolder: true
