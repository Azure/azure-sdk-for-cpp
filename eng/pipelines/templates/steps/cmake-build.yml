parameters:
  Env: ''
  GenerateArgs: ''
  Build: true
  BuildArgs: ''
  VcpkgArgs: ''
  ServiceDirectory: ''


steps:
  - script: mkdir build
    displayName: create working directory

  - script: cmake --version
    workingDirectory: build
    displayName: cmake --version

  - script: |
      ${{ parameters.Env }} cmake ${{ parameters.VcpkgArgs }} ${{ parameters.GenerateArgs }} ..
    workingDirectory: build
    displayName: cmake generate
    env:
      VCPKG_BINARY_SOURCES: $(VCPKG_BINARY_SOURCES_SECRET)

# Core should build all cmake tagets
  - ${{ if and(eq(parameters.Build, true), eq(parameters.ServiceDirectory, 'core')) }}:
    - script: cmake --build . ${{ parameters.BuildArgs }}
      workingDirectory: build
      displayName: cmake build All
      timeoutInMinutes: 20

# Non-core services define the list of targets to build
  - ${{ if and(eq(parameters.Build, true) , ne(parameters.ServiceDirectory, 'core')) }}:
    - pwsh: cmake --build . ${{ parameters.BuildArgs }} --target (Get-Content ${{ parameters.ServiceDirectory }}-targets-build.txt)
      workingDirectory: build
      displayName: cmake build Targets
      timeoutInMinutes: 20

  - pwsh: |
      New-Item -ItemType Directory -Name diagnostics
      eng/scripts/New-Screenshot.ps1 -OutFile diagnostics/screenshot.bmp
    displayName: Take screenshot 
    condition: failed()

  - publish: diagnostics
    condition: failed()
