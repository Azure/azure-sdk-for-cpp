
jobs:
  - job:
    displayName: Nightly vcpkg PR
    pool:
      name: azsdk-pool-mms-win-2019-general
      vmImage: MMS2019

    variables:
      # The branch in the azure-sdk/vcpkg repo that is updated nightly with the
      # latest set of ports
      TargetPrBranch: release/azure-sdk-for-cpp-daily-verification

    steps:
      - checkout: self

      - template: /eng/pipelines/templates/steps/generate-nightly-branch-name.yml

      - template: /eng/pipelines/templates/steps/vcpkg-clone.yml
        parameters:
          Workspace: $(Pipeline.Workspace)
          RepoOwner: azure-sdk
          SkipCheckout: true

      - template: /eng/common/pipelines/templates/steps/set-default-branch.yml
        parameters:
          WorkingDirectory: $(Pipeline.Workspace)/vcpkg

      # We have to set git identity because git merge will create a merge commit
      # in some cases and event when specifying --no-commit.
      - pwsh: |
          Write-Host 'git config user.name "azure-sdk"'
          git config user.name "azure-sdk"
          Write-Host 'git config user.email "azuresdk@microsoft.com"'
          git config user.email "azuresdk@microsoft.com"

          Write-Host "git checkout $(NightlyBranchName)"
          git checkout $(NightlyBranchName)
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Cannot check out $(NightlyBranchName) LASTEXITCODE=$LASTEXITCODE"
          }

          git checkout $(DefaultBranch)

          Write-Host "git merge $(NightlyBranchName) --strategy-option=theirs --no-commit"
          git merge $(NightlyBranchName) --strategy-option=theirs --no-commit

          Write-Host "git reset HEAD~1"
          git reset HEAD~1

          # Remove git identity configuration
          Write-Host 'git config --unset user.name'
          git config --unset user.name
          Write-Host 'git config --unset user.email'
          git config --unset user.email
        workingDirectory: $(Pipeline.Workspace)/vcpkg
        displayName: Update vcpkg Nightly Branch

      # This step will skip creating the PR if the PR already exists
      - template: /eng/common/pipelines/templates/steps/create-pull-request.yml
        parameters:
          # Force push because Update-VcpkgNightlyBranch.ps1 re-creates the 
          # nightly branch from the tip of the default branch
          PushArgs: --force
          BaseBranchName: $(DefaultBranch)
          PRBranchName: $(TargetPrBranch)
          RepoOwner: Microsoft
          RepoName: vcpkg
          WorkingDirectory: $(Pipeline.Workspace)/vcpkg
          CommitMsg: Update with changes from $(NightlyBranchName)
          PRTitle: "[DO NOT MERGE] Nightly Azure SDK for C++ CI validation"
          PRBody: This is a long-lived draft PR should not be merged. Its branch is be updated periodically to validate the Azure SDK for C++ against the vcpkg CI.
          ScriptDirectory: $(System.DefaultWorkingDirectory)/eng/common/scripts
          OpenAsDraft: true
