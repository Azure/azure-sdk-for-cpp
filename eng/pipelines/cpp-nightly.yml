
jobs:
  - job:
    displayName: Nightly vcpkg PR
    pool:
      name: azsdk-pool-mms-win-2019-general
      vmImage: MMS2019

    variables:
      # The branch in the azure-sdk/vcpkg repo that is updated nigthly with the
      # latest set of ports
      TargetPrBranch: azure-sdk-for-cpp-nightly-verification

    steps:
      - checkout: self

      - pwsh: |
          $formattedDate = Get-Date -Format 'yyyy-MM-dd'
          $branchName = "nightly/$formattedDate"
          Write-Host "##vso[task.setvariable variable=NightlyBranchName]$branchName"
        displayName: Set branch name in fork repo

      - template: eng/pipelines/templates/steps/vcpkg-clone.yml
        parameters:
          Workspace: $(Pipeline.Workspace)
          RepoOwner: azure-sdk
          PRBranchName: $(TargetPrBranch)

      - template: /eng/common/pipelines/templates/steps/set-default-branch.yml
        parameters:
          WorkingDirectory: $(Pipeline.Workspace)/vcpkg

      - task: Powershell@2
        inputs: 
          filePath: eng/scripts/Update-VcpkgNightlyBranch.ps1
          arguments: >-
            -SourceBranch $(NightlyBranchName)
            -TargetBranch $(TargetPrBranch)
            -MainBranchName $(DefaultBranch)
          pwsh: true
          workingDirectory: $(Pipeline.Workspace)/vcpkg
        displayName: Update vcpkg Nightly Branch

      - pwsh: "##vso[task.setvariable variable=HasChanges]$true"
        displayName: Set $(HasChanges) to $true

      - template: /eng/common/pipelines/templates/steps/create-pull-request.yml
        parameters:
          BaseBranchName: $(DefaultBranch)
          PRBranchName: $(TargetPrBranch)
          RepoOwner: Microsoft
          RepoName: vcpkg
          WorkingDirectory: $(Pipeline.Workspace)/vcpkg
          PRTitle: "[DO NOT MERGE] Nightly Azure SDK for C++ CI validation"
          PRBody: This is a long-lived draft PR should not be merged. Its branch is be updated periodically to validate the Azure SDK for C++ against the vcpkg CI.
          ScriptDirectory: $(System.DefaultWorkingDirectory)/eng/common/scripts
          SkipCheckingForChanges: true
          OpenAsDraft: true
